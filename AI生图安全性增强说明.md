# AI 生图功能安全性增强说明

## ✅ 已完成的修改

### 1. **提示词模板增强** (`quiz_config.dart`)

更新了默认生图提示词模板,增加了以下安全要求:

```
请为以下新年知识点生成一张可爱的儿童插画:
{knowledge}

要求:
1. 儿童插画风格,色彩明亮温暖,画面可爱有趣
2. 符合中国传统新年文化,展现节日喜庆氛围
3. 适合3-8岁儿童观看,内容健康积极
4. 画面简洁清晰,主题突出,避免复杂细节
5. 使用卡通风格,圆润可爱的造型
6. 严格禁止任何暴力、恐怖、成人或不适合儿童的内容
```

**关键安全点**:
- ✅ 明确要求儿童插画风格
- ✅ 强调可爱有趣的画面
- ✅ 严格禁止不适合儿童的内容
- ✅ 要求圆润可爱的造型,避免尖锐元素

### 2. **AI 系统提示增强** (`quiz_service.dart`)

更新了调用 AI 生成图片提示词时的系统提示:

```
你是一个专业的儿童插画提示词生成专家。请根据用户提供的内容生成适合 DALL-E 或 Stable Diffusion 的英文提示词。

严格要求:
1. 必须使用可爱、卡通、儿童插画风格
2. 色彩明亮温暖,画面简洁清晰
3. 严格禁止任何暴力、恐怖、成人或不适合儿童的内容
4. 使用圆润可爱的造型,避免尖锐或恐怖元素
5. 符合中国传统新年文化,展现节日喜庆氛围
6. 适合3-8岁儿童观看

只返回英文提示词本身,不要有其他说明。提示词中应包含: cute, cartoon, children illustration, colorful, warm, simple, Chinese New Year 等关键词。
```

**关键安全点**:
- ✅ 明确身份为儿童插画专家
- ✅ 多层次的安全要求
- ✅ 强制包含儿童友好关键词
- ✅ 禁止违禁内容的明确声明

### 3. **支持 Emoji 素材重新生成**

**现有功能**:
- ✅ `canGenerateImage` 属性已支持所有未生成或生成失败的题目
- ✅ 包括只有 emoji 图标的题目
- ✅ 用户可以通过题库管理页面为任何题目生成图片

**使用方式**:
1. 进入题库管理页面
2. 找到只有 emoji 的题目
3. 点击菜单 → "生成图片"
4. 或使用"批量生成"功能

## 🛡️ 多层安全保障

### 第一层:用户提示词模板
- 用户在配置中设置的提示词模板
- 默认包含儿童安全要求
- 用户可自定义但建议保留安全条款

### 第二层:AI 系统提示
- 调用 AI 生成英文提示词时的系统级约束
- 强制要求儿童友好风格
- 明确禁止违禁内容

### 第三层:生图 API 本身
- DALL-E 等生图 API 自带内容过滤
- 会自动拒绝违规请求

## 📋 安全检查清单

在生成图片时,系统会确保:

- [x] 使用儿童插画风格
- [x] 色彩明亮温暖
- [x] 画面可爱有趣
- [x] 圆润可爱的造型
- [x] 符合新年文化
- [x] 适合3-8岁儿童
- [x] 禁止暴力内容
- [x] 禁止恐怖元素
- [x] 禁止成人内容
- [x] 避免尖锐元素

## 🎨 生成流程

```
用户选择题目
    ↓
读取题目内容(问题+答案+解释)
    ↓
应用用户提示词模板 (第一层安全)
    ↓
调用对话 AI 生成英文提示词 (第二层安全)
    ↓
调用生图 API (第三层安全)
    ↓
下载并缓存图片
    ↓
更新题目状态
```

## 💡 使用建议

### 对于管理员
1. **保留默认提示词**:默认提示词已包含完善的安全要求
2. **自定义时注意**:如需修改,请保留安全相关条款
3. **定期检查**:批量生成后检查图片质量和安全性

### 对于开发者
1. **不要移除安全条款**:系统提示中的安全要求是必需的
2. **测试生成结果**:确保生成的图片符合儿童标准
3. **监控失败原因**:如果频繁失败,可能是提示词过于严格

## 🔄 后续优化建议

1. **人工审核机制**:对生成的图片进行人工抽查
2. **黑名单关键词**:维护一个禁用关键词列表
3. **图片质量评分**:让用户对生成的图片评分
4. **自动重试**:失败时自动调整提示词重试

---

**总结**:通过多层安全保障,确保所有 AI 生成的图片都符合儿童观看标准,安全、可爱、有趣! 🎉
