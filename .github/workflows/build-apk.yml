name: Build Android APK

on:
  workflow_dispatch:  # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º Release

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²,ç”¨äºç”Ÿæˆ commit log
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build APK
        run: flutter build apk --release
      
      # è·å–ç‰ˆæœ¬å·å’Œæ—¶é—´æˆ³ç”¨äº Release æ ‡ç­¾
      - name: Get version info
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' \r')
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION-$TIMESTAMP" >> $GITHUB_OUTPUT
      
      # è·å–ä»ä¸Šæ¬¡ tag åˆ°å½“å‰çš„ commit log
      - name: Get commit messages
        id: commits
        run: |
          # è·å–æœ€è¿‘çš„ tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # å¦‚æœæ²¡æœ‰ä¹‹å‰çš„ tag,è·å–æœ€è¿‘10ä¸ª commit
            COMMITS=$(git log -10 --pretty=format:"- %s" --no-merges)
          else
            # è·å–ä»ä¸Šæ¬¡ tag åˆ°ç°åœ¨çš„ commit
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          # å°† commit ä¿¡æ¯å†™å…¥æ–‡ä»¶,ç„¶åè¯»å–
          echo "$COMMITS" > commits.txt
          
          # ä½¿ç”¨ heredoc æ–¹å¼å†™å…¥å¤šè¡Œå†…å®¹
          {
            echo "commits<<EOF"
            cat commits.txt
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # è¾“å‡ºä¸Šæ¬¡ tag ä¿¡æ¯ç”¨äºæ˜¾ç¤º
          if [ -z "$PREV_TAG" ]; then
            echo "prev_tag=åˆå§‹ç‰ˆæœ¬" >> $GITHUB_OUTPUT
          else
            echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          fi
      
      # é‡å‘½å APK æ–‡ä»¶
      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/star-bank-${{ steps.version.outputs.version }}.apk
      
      # åˆ›å»º Release å¹¶ä¸Šä¼  APK
      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Star Bank ${{ steps.version.outputs.version }}
          body: |
            ## ğŸŒŸ Star Bank v${{ steps.version.outputs.version }}
            
            ### ğŸ“… æ„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
            - **æ„å»ºæ—¶é—´**: ${{ steps.version.outputs.timestamp }}
            - **æäº¤**: ${{ github.sha }}
            - **ä»ç‰ˆæœ¬**: ${{ steps.commits.outputs.prev_tag }}
            
            ### ğŸ“ æ›´æ–°å†…å®¹
            ${{ steps.commits.outputs.commits }}
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            è¯·ä¸‹è½½ `star-bank-${{ steps.version.outputs.version }}.apk` æ–‡ä»¶å¹¶å®‰è£…ã€‚
          files: build/app/outputs/flutter-apk/star-bank-${{ steps.version.outputs.version }}.apk
          draft: false
          prerelease: false
