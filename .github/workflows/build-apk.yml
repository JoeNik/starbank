name: Build Android APK

on:
  workflow_dispatch:  # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º Release

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²,ç”¨äºç”Ÿæˆ commit log
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build APK
        run: flutter build apk --release
      
      # è·å–ç‰ˆæœ¬å·å’Œæ—¶é—´æˆ³ç”¨äº Release æ ‡ç­¾
      - name: Get version info
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' \r')
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION-$TIMESTAMP" >> $GITHUB_OUTPUT
      
      # ç”Ÿæˆ Release è¯´æ˜æ–‡ä»¶
      - name: Generate Release Notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TIMESTAMP="${{ steps.version.outputs.timestamp }}"
          TAG_NAME="${{ steps.version.outputs.tag }}"
          
          # è·å–æœ€è¿‘çš„ tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          PREV_TAG_DISPLAY=${PREV_TAG:-"åˆå§‹ç‰ˆæœ¬"}
          
          # å¼€å§‹å†™å…¥ Markdown æ–‡ä»¶
          echo "## ğŸŒŸ Star Bank v$VERSION" > release_body.md
          echo "" >> release_body.md
          echo "### ğŸ“… æ„å»ºä¿¡æ¯" >> release_body.md
          echo "- **ç‰ˆæœ¬**: $VERSION" >> release_body.md
          echo "- **æ„å»ºæ—¶é—´**: $TIMESTAMP" >> release_body.md
          echo "- **ä»ç‰ˆæœ¬**: $PREV_TAG_DISPLAY" >> release_body.md
          echo "" >> release_body.md
          
          echo "### ğŸ“ æ›´æ–°å†…å®¹" >> release_body.md
          if [ -z "$PREV_TAG" ]; then
            # å¦‚æœæ²¡æœ‰ tagï¼Œæ˜¾ç¤ºæœ€è¿‘ 20 æ¡
            git log -20 --pretty=format:"- %s" --no-merges >> release_body.md
          else
            # æ˜¾ç¤ºä¸¤ä¸ª tag ä¹‹é—´çš„å·®å¼‚
            git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges >> release_body.md
          fi
          
          echo "" >> release_body.md
          echo "" >> release_body.md
          echo "### ğŸ“¥ ä¸‹è½½è¯´æ˜" >> release_body.md
          echo "è¯·ä¸‹è½½ \`star-bank-$VERSION.apk\` æ–‡ä»¶å¹¶å®‰è£…ã€‚" >> release_body.md
          
          # æ‰“å°å†…å®¹ä»¥ä¾›æ£€æŸ¥
          cat release_body.md
      
      # é‡å‘½å APK æ–‡ä»¶
      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/star-bank-${{ steps.version.outputs.version }}.apk
      
      # åˆ›å»º Release å¹¶ä¸Šä¼  APK
      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Star Bank ${{ steps.version.outputs.version }}
          body_path: release_body.md
          files: build/app/outputs/flutter-apk/star-bank-${{ steps.version.outputs.version }}.apk
          draft: false
          prerelease: false
          draft: false
          prerelease: false
