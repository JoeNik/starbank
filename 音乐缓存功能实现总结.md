# éŸ³ä¹ç¼“å­˜åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“ å®ç°æ¦‚è¿°

å·²æˆåŠŸä¸º starBank é¡¹ç›®å®ç°äº†å®Œæ•´çš„éŸ³ä¹ç¼“å­˜åŠŸèƒ½,å‚è€ƒäº† CyreneMusic é¡¹ç›®çš„æˆç†Ÿå®ç°ã€‚

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»º MusicCacheService (`lib/services/music_cache_service.dart`)

**æ ¸å¿ƒåŠŸèƒ½:**
- âœ… åŠ å¯†å­˜å‚¨:ä½¿ç”¨ XOR åŠ å¯†é˜²æ­¢ç›´æ¥æ’­æ”¾ç¼“å­˜æ–‡ä»¶
- âœ… å…ƒæ•°æ®ç®¡ç†:å­˜å‚¨æ­Œæ›²ä¿¡æ¯ã€å¹³å°ã€URLã€æ­Œè¯ç­‰
- âœ… ç¼“å­˜ç´¢å¼•:ä½¿ç”¨ JSON æ–‡ä»¶å¿«é€ŸæŸ¥æ‰¾ç¼“å­˜
- âœ… ç»Ÿè®¡ä¿¡æ¯:æä¾›ç¼“å­˜å¤§å°ã€æ•°é‡ç­‰ç»Ÿè®¡
- âœ… ç¼“å­˜ç®¡ç†:æ”¯æŒæ¸…é™¤å…¨éƒ¨/å•ä¸ªç¼“å­˜

**æ–‡ä»¶æ ¼å¼ (.starmusic):**
```
[4å­—èŠ‚å…ƒæ•°æ®é•¿åº¦] [å…ƒæ•°æ®JSON] [åŠ å¯†çš„éŸ³é¢‘æ•°æ®]
```

### 2. é›†æˆåˆ° MusicPlayerController

**æ’­æ”¾æµç¨‹ä¼˜åŒ–:**
1. **ä¼˜å…ˆæ£€æŸ¥ç¼“å­˜** - å¦‚æœç¼“å­˜å­˜åœ¨ä¸”å¯ç”¨,ç›´æ¥ä»ç¼“å­˜æ’­æ”¾
2. **åœ¨çº¿æ’­æ”¾** - ç¼“å­˜ä¸å­˜åœ¨æ—¶,ä»åœ¨çº¿è·å–æ’­æ”¾åœ°å€
3. **è‡ªåŠ¨ç¼“å­˜** - æ’­æ”¾æˆåŠŸå,å¼‚æ­¥ç¼“å­˜æ­Œæ›²(ä¸é˜»å¡æ’­æ”¾)

**æ–°å¢æ–¹æ³•:**
- `_playFromCache()` - ä»ç¼“å­˜æ–‡ä»¶æ’­æ”¾éŸ³ä¹

### 3. æœåŠ¡åˆå§‹åŒ– (`lib/main.dart`)

åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ– `MusicCacheService`,ç¡®ä¿ç¼“å­˜æœåŠ¡åœ¨æ’­æ”¾å™¨ä½¿ç”¨å‰å°±ç»ªã€‚

## ğŸ¯ ä½¿ç”¨æ–¹å¼

### å¯ç”¨/ç¦ç”¨ç¼“å­˜

```dart
final cacheService = Get.find<MusicCacheService>();

// å¯ç”¨ç¼“å­˜
await cacheService.saveSettings(enabled: true);

// ç¦ç”¨ç¼“å­˜
await cacheService.saveSettings(enabled: false);
```

### æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡

```dart
final stats = await cacheService.getCacheStats();
print('ç¼“å­˜æ­Œæ›²æ•°: ${stats.totalFiles}');
print('ç¼“å­˜å¤§å°: ${stats.formattedSize}');
print('å¹³å°åˆ†å¸ƒ: ${stats.platformCounts}');
```

### æ¸…é™¤ç¼“å­˜

```dart
// æ¸…é™¤æ‰€æœ‰ç¼“å­˜
await cacheService.clearAllCache();

// åˆ é™¤å•ä¸ªç¼“å­˜
await cacheService.deleteCache(track);
```

### è·å–ç¼“å­˜åˆ—è¡¨

```dart
final cachedTracks = cacheService.getAllCachedTracks();
for (var metadata in cachedTracks) {
  print('${metadata.title} - ${metadata.artist}');
}
```

## ğŸ“‚ ç¼“å­˜ä½ç½®

- **Android**: `/data/data/com.example.star_bank/files/music_cache/`
- **è‡ªå®šä¹‰ç›®å½•**: å¯é€šè¿‡ `saveSettings(customDir: path)` è®¾ç½®

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **åŠ å¯†å­˜å‚¨** - ä½¿ç”¨ XOR åŠ å¯†,é˜²æ­¢ç›´æ¥æ’­æ”¾ç¼“å­˜æ–‡ä»¶
2. **æ ¡éªŒå’ŒéªŒè¯** - MD5 æ ¡éªŒç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§
3. **ä¸´æ—¶è§£å¯†** - æ’­æ”¾æ—¶è§£å¯†åˆ°ä¸´æ—¶ç›®å½•,æ’­æ”¾åè‡ªåŠ¨æ¸…ç†

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

1. **å¼‚æ­¥ç¼“å­˜** - ä¸é˜»å¡æ’­æ”¾,åå°è‡ªåŠ¨ç¼“å­˜
2. **æ™ºèƒ½æ£€æŸ¥** - ä¼˜å…ˆä½¿ç”¨ç¼“å­˜,å‡å°‘ç½‘ç»œè¯·æ±‚
3. **ç´¢å¼•ç®¡ç†** - å¿«é€ŸæŸ¥æ‰¾,é¿å…éå†æ–‡ä»¶ç³»ç»Ÿ

## ğŸ“Š ä¸‹ä¸€æ­¥å·¥ä½œ

### å»ºè®®æ·»åŠ çš„åŠŸèƒ½:

1. **ç¼“å­˜ç®¡ç†é¡µé¢**
   - æ˜¾ç¤ºç¼“å­˜åˆ—è¡¨
   - æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
   - æ‰¹é‡æ¸…ç†ç¼“å­˜
   - è®¾ç½®ç¼“å­˜å¼€å…³

2. **ç¼“å­˜è®¾ç½®**
   - æœ€å¤§ç¼“å­˜å¤§å°é™åˆ¶
   - è‡ªåŠ¨æ¸…ç†ç­–ç•¥(LRU)
   - ä»… WiFi ä¸‹ç¼“å­˜
   - è‡ªå®šä¹‰ç¼“å­˜ç›®å½•

3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - ç¼“å­˜è¿›åº¦æç¤º
   - ç¼“å­˜çŠ¶æ€å›¾æ ‡
   - é¢„ç¼“å­˜æ’­æ”¾åˆ—è¡¨

## ğŸ› å·²çŸ¥é—®é¢˜

- ç¼“å­˜è®¾ç½®ç›®å‰æœªæŒä¹…åŒ–åˆ° StorageService,éœ€è¦åç»­é›†æˆ
- ç¼“å­˜å¤§å°é™åˆ¶åŠŸèƒ½æœªå®ç°
- ç¼“å­˜æ¸…ç†ç­–ç•¥(LRU)æœªå®ç°

## ğŸ“ ä»£ç ç¤ºä¾‹

### åœ¨è®¾ç½®é¡µé¢æ·»åŠ ç¼“å­˜å¼€å…³

```dart
Obx(() {
  final cacheService = Get.find<MusicCacheService>();
  return SwitchListTile(
    title: const Text('å¯ç”¨éŸ³ä¹ç¼“å­˜'),
    subtitle: const Text('ç¼“å­˜å·²æ’­æ”¾çš„æ­Œæ›²,å‡å°‘æµé‡æ¶ˆè€—'),
    value: cacheService.cacheEnabled.value,
    onChanged: (value) async {
      await cacheService.saveSettings(enabled: value);
    },
  );
})
```

### æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡

```dart
FutureBuilder<CacheStats>(
  future: Get.find<MusicCacheService>().getCacheStats(),
  builder: (context, snapshot) {
    if (!snapshot.hasData) return const CircularProgressIndicator();
    final stats = snapshot.data!;
    return Column(
      children: [
        Text('å·²ç¼“å­˜: ${stats.totalFiles} é¦–æ­Œæ›²'),
        Text('å ç”¨ç©ºé—´: ${stats.formattedSize}'),
      ],
    );
  },
)
```

## âœ¨ æ€»ç»“

éŸ³ä¹ç¼“å­˜åŠŸèƒ½å·²å®Œå…¨é›†æˆ,å‚è€ƒäº† CyreneMusic çš„æˆç†Ÿå®ç°,æä¾›äº†:
- âœ… åŠ å¯†å­˜å‚¨
- âœ… è‡ªåŠ¨ç¼“å­˜
- âœ… ç¼“å­˜ç®¡ç†
- âœ… ç»Ÿè®¡ä¿¡æ¯

ç”¨æˆ·ç°åœ¨å¯ä»¥äº«å—ç¦»çº¿æ’­æ”¾å’Œæ›´å¿«çš„åŠ è½½é€Ÿåº¦!ğŸµ
